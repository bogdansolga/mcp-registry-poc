#!/bin/bash

# Pre-commit hook
# Automatically catches unused code and linting issues before commits
# Bypass with: git commit --no-verify

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
CHECKS_FAILED=0

# Function to print colored output
print_error() {
    echo -e "${RED}x $1${NC}"
}

print_success() {
    echo -e "${GREEN}v $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}! $1${NC}"
}

print_info() {
    echo "i $1"
}

# Get list of staged TypeScript/JavaScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
    print_info "No TypeScript/JavaScript files staged, skipping checks"
    exit 0
fi

print_info "Checking $(echo "$STAGED_FILES" | wc -l | xargs) staged files..."
echo ""

# Check 1: TypeScript type checking (includes unused code detection)
echo "1/2  Running TypeScript type checking..."
pnpm run type-check --silent 2>&1 | tee /tmp/tsc-output.txt > /dev/null

# Check for errors in production code (src/) only
PROD_ERRORS=$(grep -E "^src/.*(error TS)" /tmp/tsc-output.txt || true)

if [ -n "$PROD_ERRORS" ]; then
    print_error "TypeScript errors found in production code"
    echo ""
    echo "   Production code errors:"
    echo "$PROD_ERRORS" | head -15
    echo ""

    # Count unused code errors
    UNUSED_COUNT=$(echo "$PROD_ERRORS" | grep -c "error TS6133\|error TS6196" || true)
    if [ $UNUSED_COUNT -gt 0 ]; then
        print_info "Found $UNUSED_COUNT unused variable/import error(s)"
    fi
    echo ""
    CHECKS_FAILED=1
else
    # Check if there are test errors (informational only)
    TEST_ERRORS=$(grep -E "^tests/.*(error TS)" /tmp/tsc-output.txt || true)
    if [ -n "$TEST_ERRORS" ]; then
        print_success "TypeScript checks passed for production code"
        print_warning "Note: $(echo "$TEST_ERRORS" | wc -l | xargs) error(s) in test files (not blocking)"
    else
        print_success "TypeScript checks passed"
    fi
fi

echo ""

# Check 2: Biome linting
echo "2/2  Running Biome linter..."
pnpm run lint --silent 2>&1 | tee /tmp/biome-output.txt > /dev/null

# Check for unused code errors in production files
BIOME_UNUSED=$(grep -E "src/.*noUnused" /tmp/biome-output.txt || true)

if [ -n "$BIOME_UNUSED" ]; then
    print_error "Biome found unused code in production files"
    echo ""
    echo "$BIOME_UNUSED" | head -10
    echo ""
    CHECKS_FAILED=1
else
    # Check for other lint errors (warnings only)
    BIOME_ERRORS=$(grep -E "src/.*lint/" /tmp/biome-output.txt || true)
    if [ -n "$BIOME_ERRORS" ]; then
        print_success "No unused code detected"
        print_warning "Note: Other lint issues found (not blocking)"
        echo ""
        print_info "Run 'pnpm run lint' to see all details"
    else
        print_success "Biome linting passed"
    fi
fi

echo ""

# Summary
if [ $CHECKS_FAILED -eq 1 ]; then
    echo "----------------------------------------"
    print_error "Pre-commit checks failed!"
    echo ""
    echo "To fix unused code issues:"
    echo "  1. Remove unused imports and variables"
    echo "  2. Prefix intentionally unused params with '_' (e.g., _request)"
    echo "  3. Run 'pnpm run type-check' to verify"
    echo ""
    echo "To bypass this hook (not recommended):"
    echo "  git commit --no-verify"
    echo "----------------------------------------"
    exit 1
else
    echo "----------------------------------------"
    print_success "All pre-commit checks passed!"
    echo "----------------------------------------"
    exit 0
fi
